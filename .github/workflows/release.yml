name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci

    - name: Set extension version from tag
      shell: bash
      run: |
        set -euo pipefail
        TAG="${GITHUB_REF_NAME}"      # 例: v0.3.2
        VER="${TAG#v}"                # 例: 0.3.2
        node -e "const fs=require('fs'); const p=require('./package.json'); p.version='${VER}'; fs.writeFileSync('package.json', JSON.stringify(p,null,2)+'\n');"
        cat package.json | head -n 30

    - name: Compile TypeScript
      run: npm run compile
      
    - name: Package extension
      run: npx @vscode/vsce package
      
    - name: Get version from tag
      id: version
      run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Generate commit list (include direct commits to main)
      shell: bash
      run: |
        set -euo pipefail
        CURRENT_TAG="${GITHUB_REF_NAME}"
        # 直近2つのタグを version順で取得（v* 前提）
        PREV_TAG=$(git tag --list 'v*' --sort=-version:refname | head -n 2 | tail -n 1)
        
        echo "# Changes" > RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "## Commits (including direct pushes to main)" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        
        if [ -n "${PREV_TAG}" ] && [ "${PREV_TAG}" != "${CURRENT_TAG}" ]; then
          echo "Changes since ${PREV_TAG}:" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          git log "${PREV_TAG}..${CURRENT_TAG}" \
            --pretty=format:'- %s (%h)' \
            --no-merges >> RELEASE_NOTES.md || echo "- No commits found" >> RELEASE_NOTES.md
        else
          echo "Initial release or all commits:" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          git log "${CURRENT_TAG}" \
            --pretty=format:'- %s (%h)' \
            --no-merges >> RELEASE_NOTES.md || echo "- No commits found" >> RELEASE_NOTES.md
        fi
        
        echo "" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "---" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "## Pull Requests (auto-generated by GitHub)" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: '*.vsix'
        generate_release_notes: true
        body_path: RELEASE_NOTES.md
        append_body: true
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
