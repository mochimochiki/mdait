# 対象言語選択UIと適用範囲フィルタ

日付: 2025-08-13

## 背景 / 目的
- transPairs が複数ある場合、現状はすべての言語ペアがステータス表示・各種コマンド（同期/翻訳など）の対象になる。
- 実運用では 1 つ、または少数の target 言語に絞って作業することが多い。
- ステータスパネルから対象言語を選べるようにし、表示とコマンドの適用範囲をフィルタ可能にする。

## 要件（確定）
- 既定は「前回の選択を復元」する。
- 初回（復元対象なし）は transPairs の一番上のペアの target を自動選択する。
- 主に単一選択での利用を想定するが、複数選択もできる必要がある。
- 「すべて」トグルは提供しない。
- 表示順は従来通り（source -> target の定義順）を維持し、フィルタのみ行う。
- 選択なしは許可しない。選択 UI では確定を無効化（空で accept させない）。
- transPairs の変化等で結果的に空になりそうな場合は、最上位の transPair の target を自動選択する。
- UI 起点は「ステータスパネル内のボタン」。

## 仕様（概要）
### 選択モデル
- activeTargets: Set<string> で target 言語コードの集合を保持（空集合不可）。
- 同一 target を持つ複数の transPair は target 単位でまとめて扱う。

### 永続化
- workspaceState に保存/復元（キー例: `mdait.activeTargets`）。
- 復元時、現在の transPairs に存在しない target は除外し、結果が空なら最上位 target を一つ選択。

### UI
- ステータスパネルのツールバーに「対象言語を選択」ボタンを追加（command: `mdait.status.selectTargets`）。
- QuickPick(canPickMany: true) で target 言語一覧（重複除去、初出順＝定義順）。
- 「OK」確定時、選択が空なら accept を抑止し、バリデーションメッセージを表示（≒確定を無効化）。
- ステータス表示は簡潔に（例: `対象: ja,en`）。

### 表示・コマンドへの反映
- Status ツリーは activeTargets に合致する transPair のみを表示。並び順は従来の定義順を踏襲。
- 同期/翻訳など既存コマンドは activeTargets に一致する transPair にのみ適用。
- 選択変更時のイベント（onActiveTargetsChanged）を発火し、ツリー再描画・コマンド側の再評価を促す。

### エッジケース
- transPairs 更新により target が増減する場合：
  - なくなった target は選択から自動除外。
  - 結果が空なら最上位 target を自動選択。
- 言語バリアント（例: zh-CN/zh-TW）は別 target として個別に扱う。

## 実装方針
### コンポーネント/責務
- SelectionState（新規）
  - activeTargets の保持、読み書き、永続化、整合性補正、イベント発火。
  - 位置候補: `src/core/status/selection-state.ts`（Status 周辺と連携しやすい場所）。
- UI: ステータスパネルのボタンと QuickPick 実装
  - 位置候補: `src/ui/status/status-tree-provider.ts` にボタン紐付け、または `extension.ts` でコマンド登録＋呼び出し。
- 適用フィルタ
  - Status 表示: `src/ui/status/status-tree-provider.ts` のデータ構築時に activeTargets でフィルタ。
  - コマンド: `src/commands/sync/sync-command.ts`, `src/commands/trans/trans-command.ts` 入口で activeTargets を取得し、対象 transPair を抽出して処理。

### データ取得/順序の扱い
- target リストは、現在有効な transPairs を上から走査して target を初出順で重複排除して作成。
- 表示・処理の対象抽出も transPairs を先頭から走査し、activeTargets に含まれるもののみ通す。

## 受け入れ基準
- VS Code 上で、ステータスパネルに「対象言語を選択」ボタンが表示される。
- ボタン押下で複数選択可能な QuickPick が出る。選択が空のときは確定できない（accept 無効相当の挙動）。
- 再起動後も前回の選択が復元される。初回は最上位 target が自動選択される。
- Status ツリーに選択された target の transPair のみが表示される。
- 同期・翻訳コマンドを実行すると、選択された target のペアのみが処理される。
- transPairs の変更で選択が無効化された場合でも、常に少なくとも1 target が選ばれた状態になる（最上位へフォールバック）。

## 影響範囲
- UI: `src/ui/status/status-tree-provider.ts`（ツールバー、表示フィルタ）
- コマンド: `src/commands/sync/sync-command.ts`, `src/commands/trans/trans-command.ts`
- 起動/連携: `src/extension.ts`（コマンド登録、状態初期化）
- 状態: `src/core/status/selection-state.ts`（新規）

## テスト方針
- ユニット: SelectionState
  - 保存/復元、transPairs 変化時の補正、空禁止の補正ロジック。
- GUI相当（test-gui）
  - ステータスボタンが QuickPick を開くこと。
  - 空選択で確定できないことの確認。
  - 選択に応じて Status ツリーがフィルタされること。
- コマンド
  - 選択に応じた対象ペア抽出が行われること（happy path + 未選択禁止の確認）。

## リスク/留意
- QuickPick の「OK 無効化」は標準では制御しにくい。createQuickPick を用い、accept イベントを抑止＋バリデーションメッセージで代替する方式を取る。
- 選択状態のソースオブトゥルースを SelectionState に一元化し、UI/コマンド双方が購読する形にする。

## 作業手順（ざっくり）
1) SelectionState 実装（保持・永続化・補正・イベント）
2) 拡張起動時に初期化＋復元、transPairs から初期選択決定
3) コマンド `mdait.status.selectTargets` 登録（ボタンから起動）
4) QuickPick 実装（空禁止、複数選択）
5) Status ツリーのフィルタ適用
6) sync/trans コマンドの対象抽出に activeTargets を適用
7) テスト追加（core, test-gui, commands）

## メモ
- Node.js の built-in import は `node:` プレフィックスを使用する。
- 既存コードのスタイルに合わせる。不要なリファクタは避ける。
- 新規パッケージ追加は行わず、既存で実装する。

## 変更見積もり（要点）
- 新規: `src/core/status/selection-state.ts`（選択状態/保存/補正/イベント）およそ ~150 行。
- package.json: コマンド `mdait.status.selectTargets` と view/title ボタン追加、l10n 追記（小変更）。
- `src/extension.ts`: SelectionState 初期化と QuickPick 実装、選択変更でツリー更新（+40–70 行）。
- `src/ui/status/status-tree-provider.ts`: transPairs を activeTargets でフィルタ（取得元のみ変更、StatusItemTree 非侵入）（+20–40 行）。
- `src/commands/sync/sync-command.ts` / `src/commands/trans/trans-command.ts`: 適用範囲を activeTargets で絞る早期フィルタ（各+数行、低リスク）。
- 互換性: targetLang 未設定でも targetDir をキーにフォールバック可能。
- UI: QuickPick は createQuickPick＋accept 抑止で「空確定不可」を実現。
- 合計: 新規1＋既存5ファイル、約 200–350 行、リファクタ不要・可読性維持。
