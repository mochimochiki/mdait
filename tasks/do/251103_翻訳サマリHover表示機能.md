# 作業チケット: 翻訳サマリHover表示機能

## 1. 概要と方針

mdaitマーカー行にマウスホバーしたとき、翻訳実行後の統計・適用された用語・用語追加候補・注意事項などをHoverで表示する。用語追加候補にはクイックアクションボタンを用意し、ワンクリックで用語集へ登録できるようにする。永続化は不要で、翻訳コマンド実行時の結果をメモリ上で保持する。

## 2. シーケンス図

```mermaid
sequenceDiagram
    participant User
    participant TransCmd as TransCommand
    participant SummaryMgr as SummaryManager
    participant Hover as HoverProvider
    
    rect rgb(200, 220, 240)
        note right of User: 翻訳実行フェーズ
        User->>TransCmd: 翻訳実行
        TransCmd->>TransCmd: 翻訳処理
        TransCmd->>SummaryMgr: saveSummary(unitHash, summary)
    end
    
    rect rgb(240, 220, 200)
        note right of User: サマリ表示フェーズ
        User->>Hover: マーカー行にホバー
        Hover->>Hover: MdaitMarker.parse()
        Hover->>SummaryMgr: getSummary(unitHash)
        SummaryMgr-->>Hover: TranslationSummary
        Hover->>Hover: MarkdownString生成
        Hover-->>User: Hover表示
    end
```

## 3. 考慮事項

- **検索キー**: 各翻訳ユニットを一意に識別するためにunitHash（ハッシュ値）を使用
- **データのライフサイクル**: ファイルクローズ時やVS Code再起動時にクリア（永続化不要）
- **パフォーマンス**: Hoverは頻繁に発火するため、マーカーパースとMap検索は十分高速である必要
- **用語候補の生成**: 既存の`term-extractor.ts`を活用してAI翻訳時に候補抽出
- **適用された用語の追跡**: 翻訳時に実際に使用された用語集のエントリを記録
- **用語追加のクイックアクション**: Hoverから直接コマンドを呼び出し、用語集に新規登録できるようにする
- **l10n対応**: Hover内のテキストも`vscode.l10n.t()`で多言語対応
- **StatusManagerとの関係**: StatusManagerは翻訳状態管理に集中、サマリは別管理（責務分離）

## 4. 実装計画と進捗

- [x] `src/ui/hover/summary-manager.ts`の実装
  - TranslationSummaryインターフェース定義
  - SummaryManagerクラス実装（Map<unitHash, summary>でユニットハッシュをキーに検索）
  - saveSummary / getSummary / clearSummary メソッド
  
- [x] `src/ui/hover/translation-summary-hover-provider.ts`の実装
  - HoverProvider実装
  - マーカー行検出ロジック
  - MarkdownString生成（統計、用語候補、注意事項）
  - commandリンク埋め込み（用語集追加など）
  
- [x] `src/commands/trans/trans-command.ts`の修正
  - 翻訳実行時にサマリデータ生成
  - SummaryManager.saveSummary()呼び出し
  - 用語候補抽出（term-extractor活用）
  
- [x] `src/extension.ts`の修正
  - SummaryManagerインスタンス生成
  - HoverProvider登録
  
- [x] l10n対応
  - Hover表示文言を`l10n/bundle.l10n.json`に追加
  - 日本語版も追加

- [x] `src/ui/hover/summary-manager.ts`の拡張
  - `TranslationSummary`に`appliedTerms`フィールドを追加
  - 適用された用語のリスト（原語→訳語のペア）を保持
  - `AppliedTerm`と`TermCandidate`インターフェースを定義
  
- [x] `src/commands/trans/trans-command.ts`の修正
  - 翻訳時に実際に適用された用語を追跡
  - `extractRelevantTerms`で抽出した用語のうち、実際に使用されたものを記録
  - `extractTermCandidates`関数を実装（大文字で始まる英単語を候補として抽出）
  - サマリに適用用語と候補用語を含めて保存
  
- [x] `src/ui/hover/translation-summary-hover-provider.ts`の拡張
  - 適用された用語セクションを追加表示（📚 適用された用語）
  - 用語追加候補セクションに「用語として登録」ボタン（commandリンク）
  - 各候補に言語ペアと原語・訳語を表示
  
- [x] `src/commands/term/command-add.ts`の新規作成
  - `mdait.addToGlossary`コマンドの実装
  - Hoverから渡された用語情報を受け取り、用語集ファイルに追記
  - YAML/CSV形式に対応し、適切なフォーマットで追記
  - 引数なしでも入力ダイアログから用語追加可能
  
- [x] `src/extension.ts`の修正
  - `mdait.addToGlossary`コマンドを登録
  - command-add.tsをimport
  
- [x] l10n対応
  - 適用用語・候補用語関連の文言を追加
  - 「用語として登録」ボタンのラベル
  - 入力ダイアログの文言（原語、訳語、コンテキスト）
  - エラーメッセージ
  
- [ ] 動作確認
  - 翻訳実行後にホバー表示されることを確認
  - 適用された用語が正しく表示されることを確認
  - 用語候補リンククリックで用語集に追加されることを確認
  - 複数ユニット翻訳時の動作確認
