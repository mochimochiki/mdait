# 作業チケット: diff管理機能実装

## 1. 概要と方針

原文変更時のdiff情報を管理し、LLMに渡すことでより正確な翻訳を実現する。gitなどVCSに依存せず、`.mdait.diff`ファイルで自前管理。unified diff形式（gzip+base64）でコンパクトに保存。

## 2. 主要な設計判断

### 2.1 diff情報の保存形式
- ファイル名：`.mdait.diff`（各翻訳対象ディレクトリに配置）
- フォーマット：1行1エントリ、`{oldhash}-{newhash} {encoded_diff}` 形式
- diff形式：unified diff（git diffと同じ、LLMが最も理解しやすい）
- エンコード：gzip圧縮後にbase64エンコード（コンパクト、検索に引っかからない）
- ライブラリ：`diff`パッケージ（npm定番、unified diff出力サポート）

例：
```
abc123def456-xyz789abc012 H4sIAAAAAAAAA6tWKkktLlGyUlAqS8wpTtVRKi1OLSrOzM+zUorRd...
```

### 2.2 need:revise@{oldhash}形式の導入
- 現在：`need:translate`のみ
- 新形式：`need:revise@{oldhash}`（原文変更時）
- これにより：
  - markerから `oldhash` が取得可能
  - `{oldhash}-{newhash}` のキーでdiff検索可能
  - trans完了後、needが消えたらdiff不要と判断できる

### 2.3 ライフサイクル管理
- **sync時**：
  - 原文変更検知時、oldハッシュとnewハッシュからdiffを計算
  - `.mdait.diff`に `{oldhash}-{newhash}` エントリを追加
  - target側markerを `need:revise@{oldhash}` に設定
  - sync終了時、全StatusItemをスキャンして不要なdiffエントリをGC
- **trans時**：
  - `need:revise@{oldhash}` を検出
  - `.mdait.diff`から `{oldhash}-{newhash}` でdiff情報を取得
  - diffをLLMプロンプトに含めて翻訳実行
  - 翻訳完了後、needをクリア（diffはsyncでGC）

## 3. 実装範囲と影響箇所

### 3.1 新規実装
- `src/core/diff/diff-manager.ts`：diff情報の読み書き・GC機能
  - `saveDiff(oldhash, newhash, oldContent, newContent, diffFilePath)`
  - `loadDiff(oldhash, newhash, diffFilePath): string | null`
  - `garbageCollect(activeOldHashes: Set<string>, diffFilePath)`
- `src/core/diff/diff-encoder.ts`：unified diff生成＋gzip/base64処理
  - `createUnifiedDiff(oldContent, newContent): string`
  - `encode(unifiedDiff): string`
  - `decode(encoded): string`

### 3.2 既存修正
- `MdaitMarker`クラス：`need:revise@{oldhash}` 形式の対応
- `sync-command.ts`の`updateSectionHashes`：diff保存＋need設定
- `trans-command.ts`：diff読み込み＋プロンプト組み込み
- `sync-command.ts`の`syncCommand`末尾：GC処理追加

## 4. 考慮事項

- `diff`パッケージの依存追加（`package.json`に追加）
- unified diffの行数制限（大きすぎる場合の対処は後回し可）
- `.mdait.diff`のVCS管理（gitignoreしない、コミット対象）
- 並列sync時の`.mdait.diff`ファイル競合（排他制御必要？）
- `.mdait.diff`ファイルのパス決定（翻訳ペアごと？プロジェクトルート？）

## 5. 実装計画と進捗

- [ ] `diff`パッケージの依存追加
- [ ] `diff-encoder.ts`の実装（unified diff生成、gzip+base64）
- [ ] `diff-manager.ts`の実装（読み書き、GC）
- [ ] `MdaitMarker`の`need:revise@{oldhash}`対応
- [ ] `sync-command.ts`の`updateSectionHashes`修正（diff保存）
- [ ] `sync-command.ts`の`syncCommand`にGC処理追加
- [ ] `trans-command.ts`の修正（diff読み込み、プロンプト組み込み）
- [ ] `.mdait.diff`ファイルパスの決定と実装
- [ ] 動作確認とテスト
