# mdait 用語集機能（`term`）設計書

## 1. 概要

用語集機能は、翻訳対象文書内での**用語の表記統一・翻訳の一貫性確保**を目的とする。
AI翻訳の前処理・支援データとして用語集を活用し、表記ゆれの自動修正・誤訳防止・用語チェックを可能にする。

---

## 2. 用語集ファイル仕様（CSV）

### 2.1 フォーマット

UTF-8（BOM あり/なしどちらも読込対応）。生成時（gen）は BOM ありで出力。ヘッダー行は必須。列の順序は任意。CSV のパース/生成は`csv-parse`を使用する。

**必須列**
少なくとも以下を必須とする。
- transPairs の sourceLang/targetLang に一致する言語コード列（例: `ja`, `en` など、複数ペアに対応可能）
- `context` 列

**任意列**
`incorrects_<lang>` 列（例: `incorrects_ja`, `incorrects_en`）。値内のカンマと衝突しないよう、当該列のセルは二重引用必須。

**例**

| ja    | en          | context  | incorrects_ja        | incorrects_en |
| ----- | ----------- | -------- | -------------------- | ------------- |
| 開発プロセス | development process | 開発全般 | "開発 プロセス,開発のプロセス" | "dev proc" |
| アカウント | account     | ユーザー識別情報 | "Account,アカウント情報" | "acc" |

### 2.2 各列の意味

例として `ja` を source、`en` を target とする場合。

- `<sourceLang>`（例: `ja`）: 原文で使用すべき統一表記（正規形）
- `<targetLang>`（例: `en`）: 対応する訳語（正規形）
- `context`: 補足情報、用語の定義、翻訳方針など（必須）
- `incorrects_<lang>`: 指定言語で正規形に正すべき揺れ表現（任意、カンマ区切り。CSV 的に二重引用必須）

### 2.3 用語集の配置

用語集ファイルは`.mdait/terms.csv` として配置するのを標準とする。

---

## 3. `term` コマンド構成

### サブコマンド一覧

| コマンド         | 説明                      |
| ------------ | ----------------------- |
| `mdait.term.gen`   | 原文と翻訳ペアから用語を自動抽出（AI使用）  |
| `mdait.term.align` | 用語表記ゆれを正規形に置換（翻訳前の整形処理） |


### ステータスツリー連携・起動経路

代表的な起動経路は StatusTree 上のアイコン（trans コマンドと同等）。StatusItem の種類に応じて実行できるようにする。

- Directory: `gen`, `align`
- File: `gen`, `align`
- Unit: `gen`, `align`

進捗表示は trans コマンドと同様に Unit 単位で行う。

---

## 4. 各コマンドの詳細仕様

### 4.1 `mdait.term.gen`

#### 目的

既存の原文と訳文から、対応する用語ペアを AI によって抽出し、用語集 (CSV) を生成。

#### 処理スコープと前提

- 起動スコープが Directory/File であっても、最終的な処理は Unit 単位に分解して行う（trans と同様）。
- 対象の言語ペアは設定の `transPairs` から決定。
- Unit の対応付けは trans と同様の方法で行い、対応する Unit ペアに対して用語抽出を行う。

#### 処理フロー（Unit ごと）

1. 対応付けられた原文/訳文 Unit を取得。
2. 各セクション内の文を AI で比較・スキャン。
3. 頻出する専門用語・固有名詞・略語などを用語候補として抽出。正規化すべき揺れがある場合は `incorrects_<lang>` に列挙。
4. 既存 terms.csv にマージ。
	- 重複判定: 設定で source として指定されている言語コード列すべてについて、各列ごとに重複（完全一致）を判定する。target のみの列は重複判定不要。
	- 競合（既存値と不一致）は現段階では無視（更新しない／要件拡張で後日対応）。
	- マージ順: 最も左の列（通常は source 列）で昇順ソート。
5. 出力: UTF-8（BOM あり）で保存。

AI 連携
- まずはモックで実装。trans と同様にモック/実 AI をいつでも切替可能とする（既存 AI サービス構成に統合）。


### 4.2 `mdait.term.align`

#### 目的

翻訳前に、原文中の表記ゆれを**統一語** に変換する。

#### 処理フロー

`ja` が source の例

1. `terms.csv` を読み込み。
2. `incorrects_ja` にある語をすべて `ja` に置換。
3. 変換後の文書を保存（差分も記録可能）。

現段階では後回し（仕様詳細は現状維持）。

---

## 5. transコマンド時のAI連携ポリシー

* 用語は文中にマークせず、AI には「このセクション（Unit）で使用すべき term リスト」として提供。
* 複数候補がある用語は、プロンプトに候補語と `context` を提示して選定。
